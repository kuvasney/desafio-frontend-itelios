<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Teste Itelios</title>
	<style>
		.hide{
			display: none;
		}
	</style>
</head>
<body>
	<div id="reference">
		<h2>VocÃª visitou:</h2>
		<div class="r">
			<h2 class="name"></h2>
			<img src="" alt="" class="prodImg">
			<p class="pr"> De <span class="oldprice"></span> por <span class="price"></span></p>	
		</div>
	</div>
	<div id="recommendation">
		<h2>talvez se interesse por:</h2>
		<div class="r">
			<h2 class="name"></h2>
			<img src="" alt="" class="prodImg">
			<p class="pr"> De <span class="oldprice"></span> por <span class="price"></span></p>	
		</div>
	</div>
	<script async>
		function reqListener () {
			// console.log(this.responseText);
		}

		var xhr = new XMLHttpRequest();
		// xhr.addEventListener("load", reqListener);
		xhr.open("GET", "produtos.json", true);
		xhr.send();
		xhr.onreadystatechange = processRequest;

		function processRequest(e) {
			if (xhr.readyState == 4 && xhr.status == 200) {
		        var response = JSON.parse(xhr.responseText);
		        var prdata = response[0].data;
		        var recommendation = prdata.recommendation;
		        var reference = prdata.reference.item;
		        console.log(prdata)
		        // console.log(prdata.recommendation.length);
		        fillrecommendation(recommendation);
		        fillReference(reference);
		    }
		};

		function fillrecommendation(products) {
			console.log(products);
			var wr = document.getElementById("recommendation"),
				r = wr.getElementsByClassName("r")[0],
				prodLimit = products.length;
				console.log(r)
				for (var i=0;i<prodLimit;i++) {
					console.log(products[i].oldPrice);
					r.getElementsByClassName("name")[0].innerHTML = products[i].name;
					// r.getElementsByClassName("price")[0].innerHTML = products[i].price;
					if(products[i].oldPrice != null) {
						r.getElementsByClassName("pr")[0].innerHTML = "De "+products[i].oldPrice+" por "+products[i].price+".";						
					} else {
						r.getElementsByClassName("pr")[0].innerHTML = "Apenas "+products[i].price+".";
					};					
					r.getElementsByClassName("prodImg")[0].setAttribute("src", products[i].imageName);
					newR = r.cloneNode(true);
					wr.appendChild(newR);
					// newR.classList.remove("hide");
					console.log(newR);
				}
		};

		function fillReference(products) {
			console.log(products);

			var wr = document.getElementById("reference"),
				r = wr.getElementsByClassName("r")[0];
				r.getElementsByClassName("prodImg")[0].setAttribute("src", products.imageName);
				r.getElementsByClassName("name")[0].innerHTML = products.name;
				if(products.oldPrice != null) {
					r.getElementsByClassName("pr")[0].innerHTML = "De "+products.oldPrice+" por "+products.price+".";						
				} else {
					r.getElementsByClassName("pr")[0].innerHTML = "Apenas "+products.price+".";
				};	
		};
		(function(){
			// xhr.onreadystatechange = fillrecommendation;			
		})();
	</script>
</body>
</html>